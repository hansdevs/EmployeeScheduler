<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule</title>

  <!-- Bootstrap CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
  />
  
  <!-- Custom CSS for schedule styling -->
  <link rel="stylesheet" href="schedule.css" />
  <style>
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
      --success-color: #198754;
      --info-color: #0dcaf0;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --light-color: #f8f9fa;
      --dark-color: #212529;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }

    .navbar {
      background-color: var(--primary-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .schedule-container {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .schedule-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .schedule-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--dark-color);
      margin: 0;
    }

    .schedule-actions {
      display: flex;
      gap: 0.5rem;
    }

    .info-section {
      background-color: rgba(13, 110, 253, 0.05);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .info-section h5 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--primary-color);
    }

    .employee-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.35rem 0.75rem;
      border-radius: 50px;
      margin: 0.25rem;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .day-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .day-toggle {
      display: inline-flex;
      align-items: center;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-toggle:hover {
      background-color: #f8f9fa;
    }

    .day-toggle input {
      margin-right: 0.5rem;
    }

    .day-toggle.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .schedule-table-wrapper {
      overflow-x: auto;
      margin-bottom: 1.5rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    #scheduleTable {
      width: 100%;
      background-color: #fff;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
    }

    #scheduleTable th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      text-align: center;
      padding: 0.75rem 0.25rem;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 0.85rem;
    }

    #scheduleTable th:first-child {
      text-align: left;
      padding-left: 1rem;
      width: 140px;
      border-top-left-radius: 6px;
    }

    #scheduleTable th:last-child {
      border-top-right-radius: 6px;
    }

    #scheduleTable td {
      border: 1px solid #dee2e6;
      padding: 0;
      height: 70px;
      position: relative;
    }

    #scheduleTable td:first-child {
      background-color: #f8f9fa;
      font-weight: 600;
      padding: 0.75rem 1rem;
      width: 140px;
    }

    .sched-cell {
      height: 70px;
      position: relative;
    }

    .cell-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      z-index: 5;
    }

    .op-hours-highlight {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .shift-bar {
      position: absolute;
      top: 8px;
      height: 54px;
      border-radius: 6px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 10;
      font-size: 0.85rem;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .shift-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }

    .schedule-footer {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn-save {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: 4px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-save:hover {
      background-color: #157347;
    }

    .btn-publish {
      background-color: var(--info-color);
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: 4px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-publish:hover {
      background-color: #0aa2c0;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .schedule-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .schedule-actions {
        width: 100%;
      }
      
      .day-toggles {
        justify-content: flex-start;
      }
    }

    /* Time indicators */
    .time-indicator {
      position: absolute;
      bottom: 2px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 0.7rem;
      color: #6c757d;
    }

    /* Tooltip for shift details */
    .shift-tooltip {
      position: absolute;
      background-color: #333;
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    /* Full-width container */
    .container-fluid {
      padding: 0 1rem;
    }

    /* Info alert */
    .info-alert {
      background-color: rgba(13, 202, 240, 0.1);
      border-left: 4px solid var(--info-color);
      padding: 0.75rem 1rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- TOP NAV BAR -->
  <div class="navbar">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <strong class="text-white me-3">Scheduler Beta</strong>
        <a href="/pages/index.html" class="text-white-50 me-3">Home</a>
        <a href="/pages/schedule.html" class="text-white me-3">Schedule</a>
        <a href="/pages/business.html" class="text-white-50 me-3">Business</a>
        <a href="/pages/employees.html" class="text-white-50 me-3">Employees</a>
        <a href="/pages/stations.html" class="text-white-50 me-3">Stations</a>
        <a href="/pages/official.html" class="text-white-50 me-3">Official&nbsp;Schedule</a>
      </div>
      <div id="localTime" class="text-white-50 small"></div>
    </div>
  </div>

  <div class="container-fluid py-4">
    <div id="statusMessage"></div>

    <div class="schedule-container">
      <div class="schedule-header">
        <h2 class="schedule-title">Schedule Manager</h2>
        <div class="schedule-actions">
          <button class="btn btn-outline-primary" onclick="loadScheduleData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>

      <!-- Stations and Employees Info -->
      <div class="row">
        <div class="col-md-6">
          <div class="info-section" id="stationsList">
            <!-- Populated by JS -->
          </div>
        </div>
        <div class="col-md-6">
          <div class="info-section" id="employeesList">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- SHIFT CREATION DAY CHECKBOXES -->
      <div class="mb-4">
        <h5 class="mb-2">Create Shifts For:</h5>
        <div class="day-toggles" id="dayToggles">
          <label class="day-toggle active"><input type="checkbox" value="0" checked> Monday</label>
          <label class="day-toggle active"><input type="checkbox" value="1" checked> Tuesday</label>
          <label class="day-toggle active"><input type="checkbox" value="2" checked> Wednesday</label>
          <label class="day-toggle active"><input type="checkbox" value="3" checked> Thursday</label>
          <label class="day-toggle active"><input type="checkbox" value="4" checked> Friday</label>
          <label class="day-toggle active"><input type="checkbox" value="5" checked> Saturday</label>
          <label class="day-toggle active"><input type="checkbox" value="6" checked> Sunday</label>
        </div>
      </div>

      <!-- VIEW DAY FILTER -->
      <div class="mb-4">
        <div class="row align-items-center">
          <div class="col-md-4">
            <label class="form-label fw-bold">View Schedule For:</label>
            <select id="viewDaySelect" class="form-select">
              <option value="0">Monday</option>
              <option value="1">Tuesday</option>
              <option value="2">Wednesday</option>
              <option value="3">Thursday</option>
              <option value="4">Friday</option>
              <option value="5">Saturday</option>
              <option value="6">Sunday</option>
            </select>
          </div>
          <div class="col-md-8">
            <div class="info-alert">
              <i class="bi bi-info-circle-fill me-2"></i>
              Click and drag on a station's row to create a shift. You'll be prompted to assign an employee.
            </div>
          </div>
        </div>
      </div>

      <!-- SCHEDULE TABLE -->
      <div class="schedule-table-wrapper">
        <table class="table table-bordered" id="scheduleTable">
          <thead>
            <tr>
              <th>Station</th>
              <!-- Hours will be added by JS -->
            </tr>
          </thead>
          <tbody id="scheduleTbody">
            <!-- Stations will be added by JS -->
          </tbody>
        </table>
      </div>

      <div class="schedule-footer">
        <button type="button" class="btn-save" onclick="saveAsDraft()">
          <i class="bi bi-save me-1"></i> Save as Draft
        </button>
        <button type="button" class="btn-publish" onclick="publishSchedule()">
          <i class="bi bi-send me-1"></i> Publish Schedule
        </button>
      </div>
    </div>
  </div>

  <!-- Tooltip element for shift details -->
  <div class="shift-tooltip" id="shiftTooltip"></div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Local time display -->
  <script>
    function updateLocalTime(){
      const now = new Date();
      const timeString = now.toLocaleString([], { 
        dateStyle: 'short',
        timeStyle: 'medium' 
      });
      document.getElementById('localTime').textContent = timeString;
    }
    setInterval(updateLocalTime, 1000);
    updateLocalTime();
  </script>

  <!-- Main Schedule Logic -->
  <script>
    // Data we will fetch from /api/schedule
    let selectedShifts = [];
    let businessInfo   = {};
    let employees      = [];
    let stations       = [];
    let isPublished    = false;

    let isMouseDown    = false;
    let startCell      = null;
    let endCell        = null;
    let startStationId = null;
    let tempShift      = null;
    let shiftTooltip   = document.getElementById('shiftTooltip');

    // On page load, fetch schedule data from the API
    $(document).ready(async function(){
      await loadScheduleData();
      setupDragLogic();
      setupDayToggles();
      // Show any initial highlight
      highlightBusinessHours();
    });

    async function loadScheduleData() {
      try {
        // Show loading indicator
        document.getElementById('statusMessage').innerHTML = 
          '<div class="alert alert-info">Loading schedule data...</div>';
        
        let res = await fetch('/api/schedule');
        if(!res.ok){
          throw new Error('Failed to load schedule data');
        }
        let data = await res.json();

        // We'll store the fetched data in our variables:
        selectedShifts = data.schedule || [];
        businessInfo   = data.business || {};
        employees      = data.employees || [];
        stations       = data.stations || [];
        isPublished    = data.is_published || false;

        // Display a note if already published
        const msgDiv = document.getElementById('statusMessage');
        msgDiv.innerHTML = isPublished 
          ? '<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>Schedule is currently published.</div>'
          : '';

        // Render station list, employee list, and schedule table
        renderStationsList(stations);
        renderEmployeesList(employees);
        buildScheduleTable(stations);

        // Once table is built, we can do the shift highlighting
        redrawShifts();
        highlightBusinessHours();

      } catch (err) {
        console.error(err);
        document.getElementById('statusMessage').innerHTML = 
          `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>${err.message}</div>`;
      }
    }

    function renderStationsList(stationsArr) {
      const div = document.getElementById('stationsList');
      if(!stationsArr || stationsArr.length === 0){
        div.innerHTML = `<h5>Stations</h5><p>No stations yet. Go to "Stations" page to add some!</p>`;
        return;
      }
      let html = `<h5>Stations</h5><ul class="list-group">`;
      stationsArr.forEach(st => {
        html += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${st.name}</span>
            <span class="badge bg-primary rounded-pill">${st.type || 'N/A'}</span>
          </li>
        `;
      });
      html += `</ul>`;
      div.innerHTML = html;
    }

    function renderEmployeesList(empArr) {
      const div = document.getElementById('employeesList');
      if(!empArr || empArr.length === 0){
        div.innerHTML = `<h5>Available Employees</h5><p>No employees yet. Go to "Employees" page to add some!</p>`;
        return;
      }
      let html = `<h5>Available Employees</h5><div>`;
      empArr.forEach(emp => {
        html += `
          <span class="employee-tag ${emp.color}">
            ${emp.name} <small>(${emp.type || 'N/A'})</small>
          </span>
        `;
      });
      html += `</div>`;
      div.innerHTML = html;
    }

    // Build the table with 24 columns for hours 0..23, plus station name col
    function buildScheduleTable(stationsArr) {
      // Build <thead> hours
      const thead = document.querySelector('#scheduleTable thead tr');
      // Clear any existing <th> (beyond the first "Station" header).
      thead.innerHTML = `<th>Station</th>`;
      for(let hour = 0; hour < 24; hour++){
        const formattedHour = hour < 10 ? `0${hour}:00` : `${hour}:00`;
        thead.innerHTML += `<th>${formattedHour}</th>`;
      }

      // Build <tbody> row for each station
      const tbody = document.getElementById('scheduleTbody');
      tbody.innerHTML = ''; // clear existing
      stationsArr.forEach(st => {
        let rowHtml = `<tr data-station-id="${st.id}">
                         <td>${st.name}</td>`;
        for(let hour=0; hour<24; hour++){
          rowHtml += `
            <td class="sched-cell" data-hour="${hour}">
              <div class="cell-overlay"></div>
              <div class="op-hours-highlight"></div>
              <div class="time-indicator">${hour}:00</div>
            </td>
          `;
        }
        rowHtml += `</tr>`;
        tbody.innerHTML += rowHtml;
      });
    }

    function setupDayToggles() {
      // Add active class to day toggles when checked
      const toggles = document.querySelectorAll('.day-toggle');
      toggles.forEach(toggle => {
        const checkbox = toggle.querySelector('input[type="checkbox"]');
        
        toggle.addEventListener('click', function(e) {
          // Prevent the default behavior
          e.preventDefault();
          
          // Toggle the checkbox
          checkbox.checked = !checkbox.checked;
          
          // Toggle the active class
          this.classList.toggle('active', checkbox.checked);
        });
      });
    }

    // Set up the drag logic using jQuery
    function setupDragLogic(){
      // Because we rebuild the table, we have to delegate or re-bind events
      $(document).off('mousedown', '.cell-overlay');
      $(document).off('mouseover', '.cell-overlay');
      $(document).off('mouseup');

      $(document).on('mousedown', '.cell-overlay', function(e){
        e.preventDefault();
        isMouseDown = true;
        startCell = $(this).closest('.sched-cell');
        endCell   = startCell;
        startStationId = $(this).closest('tr').data('station-id');
        let minHour = parseInt(startCell.data('hour'));
        tempShift = {
          station_id: startStationId,
          employee_id: null,
          start: minHour,
          end: minHour + 1,
          days: getCheckedDays()
        };
        redrawShifts();
      });

      $(document).on('mouseover', '.cell-overlay', function(){
        if(isMouseDown && tempShift){
          let stId = $(this).closest('tr').data('station-id');
          if(stId === startStationId){
            endCell = $(this).closest('.sched-cell');
            let minH = Math.min(parseInt(startCell.data('hour')), parseInt(endCell.data('hour')));
            let maxH = Math.max(parseInt(startCell.data('hour')), parseInt(endCell.data('hour'))) + 1;
            tempShift.start = minH;
            tempShift.end   = maxH;
            redrawShifts();
          }
        }
      });

      $(document).on('mouseup', function(){
        if(!isMouseDown) return;
        isMouseDown = false;
        if(tempShift){
          // Create a modal for employee selection instead of a prompt
          showEmployeeSelectionModal(tempShift);
        }
      });

      // Add tooltip behavior for shift bars
      $(document).on('mouseenter', '.shift-bar', function(e) {
        const shiftDetails = $(this).data('shift-details');
        if (shiftDetails) {
          shiftTooltip.innerHTML = shiftDetails;
          shiftTooltip.style.opacity = '1';
          
          // Position the tooltip near the mouse
          const rect = this.getBoundingClientRect();
          shiftTooltip.style.top = (rect.top - 40) + 'px';
          shiftTooltip.style.left = (rect.left + rect.width/2 - 100) + 'px';
        }
      });

      $(document).on('mouseleave', '.shift-bar', function() {
        shiftTooltip.style.opacity = '0';
      });
    }

    function showEmployeeSelectionModal(shift) {
      // Create a modal for employee selection
      const modalHtml = `
        <div class="modal fade" id="employeeSelectionModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Assign Employee to Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Select an employee for this shift (${pad(shift.start)}:00 - ${pad(shift.end)}:00):</p>
                <div class="list-group">
                  ${employees.map(emp => `
                    <button type="button" class="list-group-item list-group-item-action d-flex align-items-center" 
                            onclick="assignEmployee(${emp.id})">
                      <span class="employee-tag ${emp.color} me-2">${emp.name}</span>
                      <small>${emp.type || 'N/A'}</small>
                    </button>
                  `).join('')}
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remove any existing modal
      const existingModal = document.getElementById('employeeSelectionModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // Add the modal to the document
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Store the shift in a global variable for the assignEmployee function
      window.currentTempShift = shift;
      
      // Show the modal
      const modal = new bootstrap.Modal(document.getElementById('employeeSelectionModal'));
      modal.show();
    }

    function assignEmployee(employeeId) {
      const shift = window.currentTempShift;
      if (!shift) return;
      
      shift.employee_id = employeeId;
      
      // finalize => remove old shift for those days + station + employee
      shift.days.forEach(d => {
        // remove old shift for same station+employee+day
        selectedShifts = selectedShifts.filter(s => 
          !(s.station_id===shift.station_id && 
            s.employee_id===shift.employee_id && 
            s.day===d)
        );
        // push new shift
        selectedShifts.push({
          station_id: shift.station_id,
          employee_id: shift.employee_id,
          start: shift.start,
          end: shift.end,
          day: d
        });
      });

      // Close the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('employeeSelectionModal'));
      modal.hide();
      
      // Clear the temp shift
      window.currentTempShift = null;
      tempShift = null;
      
      // Redraw the shifts
      redrawShifts();
    }

    function findEmployee(empNameOrId) {
      // Try numeric ID first
      let eId = parseInt(empNameOrId, 10);
      if(!isNaN(eId)){
        return employees.find(e => e.id === eId);
      } else {
        // match by name, ignoring case
        return employees.find(e => e.name.toLowerCase() === empNameOrId.toLowerCase());
      }
    }

    function getCheckedDays(){
      let days = [];
      $('#dayToggles input[type="checkbox"]:checked').each(function(){
        days.push(parseInt($(this).val()));
      });
      return days;
    }
    
    function getViewDay(){
      return parseInt($('#viewDaySelect').val());
    }

    // Redraw all shifts in the table
    function redrawShifts(){
      // Remove old bars
      $('.shift-bar').remove();
      // Draw final shifts
      selectedShifts.forEach(s => drawBar(s, false));
      // Draw temp shift
      if(tempShift){
        tempShift.days.forEach(d => {
          if(d === getViewDay()){
            drawBar({
              station_id: tempShift.station_id,
              employee_id: tempShift.employee_id,
              start: tempShift.start,
              end: tempShift.end,
              day: d
            }, true);
          }
        });
      }
    }

    function drawBar(shift, isTemp){
      let viewDay = getViewDay();
      if(shift.day !== viewDay) return;
      
      // Find the station row
      let row = $('tr[data-station-id="'+shift.station_id+'"]');
      if(!row.length) return;

      // Get all cells in the row
      let cells = row.find('.sched-cell');
      
      // Get the start and end cells
      let startCell = cells.eq(shift.start);
      let endCell = cells.eq(shift.end - 1);
      
      if(!startCell.length || !endCell.length) return;
      
      // Calculate position and width
      let startRect = startCell[0].getBoundingClientRect();
      let endRect = endCell[0].getBoundingClientRect();
      let rowRect = row[0].getBoundingClientRect();
      
      // Calculate the width of the shift bar
      let width = (endRect.right - startRect.left);
      
      // Format times for display
      let startStr = pad(shift.start)+":00";
      let endStr = pad(shift.end)+":00";

      // Find the employee
      let assignedEmp = employees.find(e => e.id===shift.employee_id);
      let colorClass = assignedEmp ? assignedEmp.color : "block-blue";
      let label = assignedEmp ? assignedEmp.name : "Unassigned";
      
      // Create a more detailed tooltip
      let tooltipContent = `
        <strong>${assignedEmp ? assignedEmp.name : 'Unassigned'}</strong><br>
        Time: ${startStr} - ${endStr}<br>
        Day: ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][shift.day]}<br>
        ${assignedEmp && assignedEmp.type ? 'Role: ' + assignedEmp.type : ''}
      `;

      // Create the shift bar
      let bar = $(`
        <div class="shift-bar ${colorClass}" style="left:0; width:${width}px;">
          ${label} (${startStr}-${endStr})
        </div>
      `);
      
      // Store the tooltip content as data
      bar.data('shift-details', tooltipContent);
      
      if(isTemp) bar.css('opacity','0.7');
      
      // Append the bar to the first cell of the row and position it correctly
      startCell.css('position', 'relative').append(bar);
    }

    function highlightBusinessHours(){
      let d = getViewDay();
      if(!businessInfo.hours || !businessInfo.hours[d]){
        // If there's no hours info, just do nothing
        return;
      }
      let openH  = businessInfo.hours[d].open;
      let closeH = businessInfo.hours[d].close;
      $('.sched-cell').each(function(){
        let h = $(this).data('hour');
        let hiDiv = $(this).find('.op-hours-highlight');
        if(h >= openH && h < closeH){
          hiDiv.css('background-color','rgba(48, 209, 88, 0.2)');
        } else {
          hiDiv.css('background-color','transparent');
        }
      });
    }

    function pad(n){ return (n<10?'0'+n:n); }

    // ------------------------------
    //  Saving (Draft or Publish)
    // ------------------------------
    async function saveAsDraft(){
      try {
        // Show saving indicator
        document.getElementById('statusMessage').innerHTML = 
          '<div class="alert alert-info">Saving draft...</div>';
          
        const body = { 
          shifts: selectedShifts,
          action: "draft"
        };
        let res = await fetch('/api/schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let data = await res.json();
        console.log(data);
        
        document.getElementById('statusMessage').innerHTML = 
          '<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>Schedule saved as draft!</div>';
          
        // Fade out the message after 3 seconds
        setTimeout(() => {
          const msgDiv = document.getElementById('statusMessage');
          msgDiv.style.transition = 'opacity 1s';
          msgDiv.style.opacity = '0';
          setTimeout(() => {
            msgDiv.innerHTML = '';
            msgDiv.style.opacity = '1';
          }, 1000);
        }, 3000);
      } catch (err) {
        console.error(err);
        document.getElementById('statusMessage').innerHTML = 
          `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Error saving schedule: ${err.message}</div>`;
      }
    }

    async function publishSchedule(){
      try {
        // Confirm before publishing
        if(!confirm('Are you sure you want to publish this schedule? This will make it visible to all employees.')) {
          return;
        }
        
        // Show publishing indicator
        document.getElementById('statusMessage').innerHTML = 
          '<div class="alert alert-info">Publishing schedule...</div>';
          
        const body = { 
          shifts: selectedShifts,
          action: "publish"
        };
        let res = await fetch('/api/schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let data = await res.json();
        console.log(data);
        
        if(data.status === 'published'){
          document.getElementById('statusMessage').innerHTML = 
            '<div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i>Schedule published successfully!</div>';
          isPublished = true;
        } else {
          document.getElementById('statusMessage').innerHTML = 
            `<div class="alert alert-warning"><i class="bi bi-exclamation-circle-fill me-2"></i>Unexpected response: ${JSON.stringify(data)}</div>`;
        }
      } catch (err) {
        console.error(err);
        document.getElementById('statusMessage').innerHTML = 
          `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Error publishing schedule: ${err.message}</div>`;
      }
    }

    // When the user changes the View Day, re-draw
    $('#viewDaySelect').on('change', function(){
      redrawShifts();
      highlightBusinessHours();
    });
  </script>
</body>
</html>

